name: Deploy to Production Environment (FTP)

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã‹ï¼Ÿ (yes/no)'
        required: true
        default: 'no'
        type: choice
        options:
        - 'no'
        - 'yes'
      deployment_note:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®èª¬æ˜'
        required: false
        default: ''

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
    - name: Validate deployment confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_deployment }}" != "yes" ]; then
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"

  deploy-production:
    runs-on: ubuntu-latest
    needs: validate-input
    environment: production
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, mysqli
        
    - name: Create production deployment package
      run: |
        echo "ğŸ“¦ æœ¬ç•ªç”¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆä¸­..."
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p uploads temp logs cache backups
        
        # æœ¬ç•ªç”¨.htaccessãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        Options -Indexes
        <Files ~ "^\.">
            Order allow,deny
            Deny from all
        </Files>
        <Files ~ "config\.php$">
            Order allow,deny
            Deny from all
        </Files>
        <Files ~ "backup\.php$">
            Order allow,deny
            Deny from all
        </Files>
        <Directory "uploads">
            php_flag engine off
            AddType text/plain .php .php3 .phtml .pht
        </Directory>
        <Directory "logs">
            Order allow,deny
            Deny from all
        </Directory>
        <Directory "backups">
            Order allow,deny
            Deny from all
        </Directory>
        php_value upload_max_filesize 10M
        php_value post_max_size 10M
        php_value max_execution_time 300
        php_value memory_limit 256M
        php_flag display_errors Off
        php_flag log_errors On
        EOF
        
        echo "âœ… æœ¬ç•ªç”¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†"

    - name: Deploy to Production Server via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.PROD_FTP_SERVER }}
        username: ${{ secrets.PROD_FTP_USERNAME }}
        password: ${{ secrets.PROD_FTP_PASSWORD }}
        server-dir: ${{ secrets.PROD_FTP_SERVER_DIR }}
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.github/**
          **/tests/**
          **/.env
          **/README.md
          **/deploy-package/**
        
    - name: Verify production deployment
      run: |
        echo "ğŸŒ æœ¬ç•ªç’°å¢ƒURL:"
        echo "  - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ : https://tw1nkle.com/Smiley/meal-delivery/smiley-kitchen/billing-system/"
        echo "  - æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ : https://tw1nkle.com/Smiley/meal-delivery/smiley-kitchen/order/"
        echo "âœ… æœ¬ç•ªFTPãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

    - name: Send success notification
      if: success()
      run: |
        echo "ğŸ‰ æœ¬ç•ªç’°å¢ƒã¸ã®FTPãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        echo "ğŸ“ ç¢ºèªURL:"
        echo "  - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ : https://tw1nkle.com/Smiley/meal-delivery/smiley-kitchen/billing-system/"
        echo "  - æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ : https://tw1nkle.com/Smiley/meal-delivery/smiley-kitchen/order/"
        echo "ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®èª¬æ˜: ${{ github.event.inputs.deployment_note }}"
        echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã®å‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„"
        
    - name: Send failure notification  
      if: failure()
      run: |
        echo "âŒ æœ¬ç•ªç’°å¢ƒã¸ã®FTPãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦FTPè¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„"
        echo "ğŸš¨ æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
