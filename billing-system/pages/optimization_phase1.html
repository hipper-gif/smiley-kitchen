<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ– Phase 1 - å®Ÿè¡Œç”»é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bg-smiley { background-color: #2E8B57; }
        .text-smiley { color: #2E8B57; }
        .console-output {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        .step-card {
            border-left: 4px solid #2E8B57;
            margin-bottom: 20px;
        }
        .step-completed {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .step-running {
            border-left-color: #ffc107;
            background-color: #fffef8;
        }
        .step-pending {
            border-left-color: #dee2e6;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-smiley text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-database me-2"></i>
                            ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ– Phase 1: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼†ç¾çŠ¶ç¢ºèª
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- é€²æ—è¡¨ç¤º -->
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <h5>å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—</h5>
                                <div class="step-card card step-pending" id="step1">
                                    <div class="card-body py-2">
                                        <strong>Step 1:</strong> ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æ
                                        <div id="step1-status" class="small text-muted">å¾…æ©Ÿä¸­...</div>
                                    </div>
                                </div>
                                <div class="step-card card step-pending" id="step2">
                                    <div class="card-body py-2">
                                        <strong>Step 2:</strong> å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                                        <div id="step2-status" class="small text-muted">å¾…æ©Ÿä¸­...</div>
                                    </div>
                                </div>
                                <div class="step-card card step-pending" id="step3">
                                    <div class="card-body py-2">
                                        <strong>Step 3:</strong> ãƒ‡ãƒ¼ã‚¿é‡ç¢ºèª
                                        <div id="step3-status" class="small text-muted">å¾…æ©Ÿä¸­...</div>
                                    </div>
                                </div>
                                <div class="step-card card step-pending" id="step4">
                                    <div class="card-body py-2">
                                        <strong>Step 4:</strong> ä¾å­˜é–¢ä¿‚ç¢ºèª
                                        <div id="step4-status" class="small text-muted">å¾…æ©Ÿä¸­...</div>
                                    </div>
                                </div>
                                <div class="step-card card step-pending" id="step5">
                                    <div class="card-body py-2">
                                        <strong>Step 5:</strong> æœ€é©åŒ–ãƒ—ãƒ©ãƒ³ç”Ÿæˆ
                                        <div id="step5-status" class="small text-muted">å¾…æ©Ÿä¸­...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <h5>å®Ÿè¡Œçµ±è¨ˆ</h5>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h3 id="totalTables" class="text-smiley">0</h3>
                                                <small>åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«æ•°</small>
                                            </div>
                                            <div class="col-6">
                                                <h3 id="totalColumns" class="text-warning">0</h3>
                                                <small>ç·ã‚«ãƒ©ãƒ æ•°</small>
                                            </div>
                                            <div class="col-6 mt-3">
                                                <h3 id="totalRows" class="text-info">0</h3>
                                                <small>ç·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°</small>
                                            </div>
                                            <div class="col-6 mt-3">
                                                <h3 id="backupSize" class="text-success">0KB</h3>
                                                <small>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚º</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                        <div class="row mb-4">
                            <div class="col-12 text-center">
                                <button id="startOptimization" class="btn btn-lg bg-smiley text-white me-3">
                                    <i class="fas fa-play me-2"></i>Phase 1 å®Ÿè¡Œé–‹å§‹
                                </button>
                                <button id="downloadBackup" class="btn btn-lg btn-success me-3" disabled>
                                    <i class="fas fa-download me-2"></i>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                                <button id="viewResults" class="btn btn-lg btn-info" disabled>
                                    <i class="fas fa-chart-bar me-2"></i>åˆ†æçµæœè¡¨ç¤º
                                </button>
                            </div>
                        </div>

                        <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ› -->
                        <div class="row">
                            <div class="col-12">
                                <h5>å®Ÿè¡Œãƒ­ã‚°</h5>
                                <div id="consoleOutput" class="console-output">
                                    ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ã€‚ã€ŒPhase 1 å®Ÿè¡Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æçµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal fade" id="resultsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-smiley text-white">
                        <h5 class="modal-title">åˆ†æçµæœè©³ç´°</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="analysisResults">
                            <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 0;
        let analysisData = {};

        document.getElementById('startOptimization').addEventListener('click', function() {
            this.disabled = true;
            startPhase1Execution();
        });

        document.getElementById('viewResults').addEventListener('click', function() {
            showAnalysisResults();
        });

        async function startPhase1Execution() {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = 'ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ– Phase 1 é–‹å§‹...\n';

            try {
                // Step 1: ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æ
                await executeStep(1, 'ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æ', async () => {
                    const response = await fetch('../api/optimization_phase1.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'analyze_structure' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        analysisData.structure = data.data;
                        updateStatistics(data.data);
                        appendConsole('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æå®Œäº†\n');
                        
                        // åˆ†æçµæœã®è¡¨ç¤º
                        for (const [table, info] of Object.entries(data.data)) {
                            appendConsole(`ğŸ“Š ${table}: ${info.column_count}ã‚«ãƒ©ãƒ , ${info.row_count}ä»¶\n`);
                        }
                    } else {
                        throw new Error(data.message);
                    }
                });

                // Step 2: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                await executeStep(2, 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ', async () => {
                    appendConsole('ğŸ“¦ å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­...\n');
                    const response = await fetch('../api/optimization_phase1.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'create_backup' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        analysisData.backup = data.data;
                        document.getElementById('downloadBackup').disabled = false;
                        document.getElementById('backupSize').textContent = data.data.size;
                        appendConsole(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${data.data.filename}\n`);
                    } else {
                        throw new Error(data.message);
                    }
                });

                // Step 3: ãƒ‡ãƒ¼ã‚¿é‡ç¢ºèª
                await executeStep(3, 'ãƒ‡ãƒ¼ã‚¿é‡ç¢ºèª', async () => {
                    const response = await fetch('../api/optimization_phase1.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'check_data_volume' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        analysisData.volume = data.data;
                        document.getElementById('totalRows').textContent = data.data.total_rows;
                        appendConsole(`ğŸ“ˆ ç·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${data.data.total_rows}ä»¶\n`);
                    } else {
                        throw new Error(data.message);
                    }
                });

                // Step 4: ä¾å­˜é–¢ä¿‚ç¢ºèª
                await executeStep(4, 'ä¾å­˜é–¢ä¿‚ç¢ºèª', async () => {
                    const response = await fetch('../api/optimization_phase1.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'check_dependencies' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        analysisData.dependencies = data.data;
                        appendConsole('ğŸ”— å¤–éƒ¨ã‚­ãƒ¼ä¾å­˜é–¢ä¿‚ç¢ºèªå®Œäº†\n');
                    } else {
                        throw new Error(data.message);
                    }
                });

                // Step 5: æœ€é©åŒ–ãƒ—ãƒ©ãƒ³ç”Ÿæˆ
                await executeStep(5, 'æœ€é©åŒ–ãƒ—ãƒ©ãƒ³ç”Ÿæˆ', async () => {
                    const response = await fetch('../api/optimization_phase1.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'generate_plan' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        analysisData.plan = data.data;
                        appendConsole('ğŸ¯ æœ€é©åŒ–ãƒ—ãƒ©ãƒ³ç”Ÿæˆå®Œäº†\n');
                        
                        // ãƒ—ãƒ©ãƒ³æ¦‚è¦è¡¨ç¤º
                        for (const [table, plan] of Object.entries(data.data)) {
                            const reduction = plan.current_columns - plan.target_columns;
                            appendConsole(`   ${table}: ${plan.current_columns} â†’ ${plan.target_columns} (-${reduction}ã‚«ãƒ©ãƒ )\n`);
                        }
                    } else {
                        throw new Error(data.message);
                    }
                });

                appendConsole('\nâœ… Phase 1 å®Œäº†!\n');
                appendConsole('==========================================\n');
                appendConsole('ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: Phase 2 æœ€é©åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ\n');
                
                document.getElementById('viewResults').disabled = false;

            } catch (error) {
                appendConsole(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n`);
                console.error('Phase 1 execution error:', error);
            }
        }

        async function executeStep(stepNum, stepName, stepFunction) {
            const stepElement = document.getElementById(`step${stepNum}`);
            const statusElement = document.getElementById(`step${stepNum}-status`);
            
            // ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹
            stepElement.className = 'step-card card step-running';
            statusElement.textContent = 'å®Ÿè¡Œä¸­...';
            statusElement.className = 'small text-warning';
            
            appendConsole(`ğŸ”„ Step ${stepNum}: ${stepName} é–‹å§‹\n`);
            
            try {
                await stepFunction();
                
                // ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†
                stepElement.className = 'step-card card step-completed';
                statusElement.textContent = 'å®Œäº†';
                statusElement.className = 'small text-success';
                
            } catch (error) {
                // ã‚¹ãƒ†ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼
                stepElement.className = 'step-card card border-danger';
                statusElement.textContent = 'ã‚¨ãƒ©ãƒ¼';
                statusElement.className = 'small text-danger';
                throw error;
            }
        }

        function appendConsole(text) {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML += text;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function updateStatistics(structureData) {
            let totalTables = Object.keys(structureData).length;
            let totalColumns = 0;
            
            for (const tableData of Object.values(structureData)) {
                totalColumns += tableData.column_count;
            }
            
            document.getElementById('totalTables').textContent = totalTables;
            document.getElementById('totalColumns').textContent = totalColumns;
        }

        function showAnalysisResults() {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = '<div class="row">';
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æçµæœ
            if (analysisData.structure) {
                html += '<div class="col-md-6 mb-4">';
                html += '<h6 class="text-smiley">ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ åˆ†æ</h6>';
                html += '<div class="table-responsive">';
                html += '<table class="table table-sm table-bordered">';
                html += '<thead class="table-light"><tr><th>ãƒ†ãƒ¼ãƒ–ãƒ«</th><th>ã‚«ãƒ©ãƒ æ•°</th><th>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°</th><th>ã‚µã‚¤ã‚º</th></tr></thead>';
                html += '<tbody>';
                
                for (const [table, data] of Object.entries(analysisData.structure)) {
                    html += `<tr>
                        <td><strong>${table}</strong></td>
                        <td>${data.column_count}</td>
                        <td>${data.row_count}</td>
                        <td>${data.data_size}</td>
                    </tr>`;
                }
                html += '</tbody></table></div></div>';
            }
            
            // æœ€é©åŒ–ãƒ—ãƒ©ãƒ³
            if (analysisData.plan) {
                html += '<div class="col-md-6 mb-4">';
                html += '<h6 class="text-smiley">ğŸ¯ æœ€é©åŒ–ãƒ—ãƒ©ãƒ³</h6>';
                html += '<div class="table-responsive">';
                html += '<table class="table table-sm table-bordered">';
                html += '<thead class="table-light"><tr><th>ãƒ†ãƒ¼ãƒ–ãƒ«</th><th>ç¾åœ¨</th><th>ç›®æ¨™</th><th>å‰Šæ¸›</th><th>å‰Šæ¸›ç‡</th></tr></thead>';
                html += '<tbody>';
                
                for (const [table, plan] of Object.entries(analysisData.plan)) {
                    const reduction = plan.current_columns - plan.target_columns;
                    const reductionRate = ((reduction / plan.current_columns) * 100).toFixed(1);
                    
                    html += `<tr>
                        <td><strong>${table}</strong></td>
                        <td>${plan.current_columns}</td>
                        <td>${plan.target_columns}</td>
                        <td class="text-danger">-${reduction}</td>
                        <td class="text-success">${reductionRate}%</td>
                    </tr>`;
                }
                html += '</tbody></table></div></div>';
            }
            
            html += '</div>';
            
            // ä¾å­˜é–¢ä¿‚æƒ…å ±
            if (analysisData.dependencies) {
                html += '<div class="row mt-4">';
                html += '<div class="col-12">';
                html += '<h6 class="text-smiley">ğŸ”— å¤–éƒ¨ã‚­ãƒ¼ä¾å­˜é–¢ä¿‚</h6>';
                html += '<div class="alert alert-info">';
                
                for (const [table, deps] of Object.entries(analysisData.dependencies)) {
                    if (deps && deps.length > 0) {
                        html += `<strong>${table}ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§:</strong><br>`;
                        for (const dep of deps) {
                            html += `&nbsp;&nbsp;â€¢ ${dep.table}.${dep.column} â†’ ${dep.referenced_table}.${dep.referenced_column}<br>`;
                        }
                        html += '<br>';
                    }
                }
                
                html += '</div></div></div>';
            }
            
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±
            if (analysisData.backup) {
                html += '<div class="row mt-4">';
                html += '<div class="col-12">';
                html += '<h6 class="text-smiley">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±</h6>';
                html += '<div class="alert alert-success">';
                html += `<strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${analysisData.backup.filename}<br>`;
                html += `<strong>ã‚µã‚¤ã‚º:</strong> ${analysisData.backup.size}<br>`;
                html += `<strong>ä½œæˆæ—¥æ™‚:</strong> ${new Date().toLocaleString('ja-JP')}<br>`;
                html += '<button class="btn btn-sm btn-success mt-2" onclick="downloadBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>';
                html += '</div></div></div>';
            }
            
            resultsDiv.innerHTML = html;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resultsModal.show();
        }

        function downloadBackup() {
            if (analysisData.backup && analysisData.backup.filename) {
                const link = document.createElement('a');
                link.href = `../backups/optimization/${analysisData.backup.filename}`;
                link.download = analysisData.backup.filename;
                link.click();
            }
        }

        // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            appendConsole('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ã€‚ã€ŒPhase 1 å®Ÿè¡Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚\n');
            appendConsole('âš ï¸ å®Ÿè¡Œå‰ã®æ³¨æ„äº‹é …:\n');
            appendConsole('1. ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™\n');
            appendConsole('2. åˆ†æã®ã¿ã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¯è¡Œã„ã¾ã›ã‚“\n');
            appendConsole('3. å®Ÿè¡Œæ™‚é–“ã¯ç´„1-2åˆ†ç¨‹åº¦ã§ã™\n\n');
        });
    </script>
</body>
</html>
